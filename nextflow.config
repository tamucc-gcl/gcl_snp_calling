// nextflow.config

// Global default params
params {
    // Input/Output
    bams = "*.bam"
    reference = "reference.fasta"
    output_dir = "results"
    output_vcf = "combined_variants.vcf.gz"
    
    // Processing parameters
    num_chunks = 10  // Number of chunks to split genome into
    
    // Configuration files
    freebayes_config = null
    bam_filter_config = null
    ploidy_map = null
    
    // QC and Reporting parameters (NEW)
    generate_report = true
    check_contamination = true
    validate_filters = true
    generate_publication_tables = false

    // Help
    help = false
}

process {
  executor = 'slurm'
  queue = 'normal'
  scratch = true
  errorStrategy = 'retry'
  maxRetries = 2

  // No global publishDir - only COMBINE_VCFS will publish

  withName: CREATE_CHUNKS {
    cpus = 64
    time = '96h'
    //memory = '32 GB'
    conda = 'bioconda::samtools=1.17'
  }

  withName: FILTER_BAMS {
    cpus = 64
    time = '96h'
    //memory = '16 GB'
    conda = 'bioconda::samtools=1.17'
  }

  withName: FREEBAYES_CHUNK {
    cpus = 64
    time = '96h'
    //memory = '32 GB'
    conda = 'bioconda::freebayes=1.3.6 bioconda::samtools=1.17 bioconda::htslib=1.17'
  }

  withName: COMBINE_VCFS {
    cpus = 64
    time = '96h'
    //memory = '16 GB'
    conda = 'bioconda::bcftools=1.17 bioconda::htslib=1.17'
  }

  withName: SUMMARIZE_VCFS {
    cpus = 64
    time = '96h'
    //memory = '16 GB'
    conda = 'bioconda::bcftools=1.17'
  }

  withName: VARIANT_STATS {
      cpus = 4
      time = '4h'
      memory = '16 GB'
      conda = 'bioconda::bcftools=1.17 conda-forge::python=3.9 conda-forge::pandas=2.0 conda-forge::numpy=1.24'
    }

    withName: SAMPLE_QC {
      cpus = 4
      time = '4h'
      memory = '16 GB'
      conda = 'bioconda::bcftools=1.17 bioconda::bedtools=2.31.0 conda-forge::python=3.9 conda-forge::bc'
    }

    withName: LOCUS_QC {
      cpus = 4
      time = '6h'
      memory = '24 GB'
      conda = 'bioconda::bcftools=1.17 bioconda::bedtools=2.31.0 conda-forge::python=3.9 conda-forge::bc'
    }

    withName: CONTAMINATION_CHECK {
      cpus = 4
      time = '2h'
      memory = '16 GB'
      conda = '''
        bioconda::bcftools=1.17 
        conda-forge::python=3.9 
        conda-forge::pandas=2.0 
        conda-forge::numpy=1.24
        conda-forge::r-base=4.3
        conda-forge::r-tidyverse=2.0
        conda-forge::r-ggplot2=3.4
        conda-forge::r-gridextra
        conda-forge::r-viridis
      '''
    }

    withName: GENERATE_PLOTS {
      cpus = 4
      time = '4h'
      memory = '32 GB'
      conda = '''
        conda-forge::r-base=4.3
        conda-forge::r-tidyverse=2.0
        conda-forge::r-ggplot2=3.4
        conda-forge::r-scales
        conda-forge::r-viridis
        conda-forge::r-gridextra
        conda-forge::r-cowplot
        conda-forge::r-ggrepel
        conda-forge::r-pheatmap
      '''
    }

    withName: FILTER_RECOMMENDATIONS {
      cpus = 2
      time = '2h'
      memory = '8 GB'
      conda = '''
        bioconda::bcftools=1.17
        conda-forge::python=3.9
        conda-forge::pandas=2.0
        conda-forge::numpy=1.24
        conda-forge::bc
      '''
    }

    withName: FILTER_VALIDATION {
      cpus = 4
      time = '4h'
      memory = '16 GB'
      conda = '''
        bioconda::bcftools=1.17
        conda-forge::python=3.9
        conda-forge::pandas=2.0
        conda-forge::r-base=4.3
        conda-forge::r-tidyverse=2.0
        conda-forge::r-ggplot2=3.4
        conda-forge::r-gridextra
        conda-forge::r-scales
        conda-forge::bc
      '''
    }

    withName: PUBLICATION_TABLES {
      cpus = 2
      time = '2h'
      memory = '8 GB'
      conda = '''
        conda-forge::r-base=4.3
        conda-forge::r-tidyverse=2.0
        conda-forge::r-knitr
        conda-forge::r-kableextra
        conda-forge::r-jsonlite
        conda-forge::r-officer
        conda-forge::r-flextable
      '''
    }

    withName: GENERATE_REPORT {
      cpus = 2
      time = '2h'
      memory = '8 GB'
      conda = '''
        conda-forge::pandoc=3.1
        conda-forge::python=3.9
        conda-forge::r-base=4.3
        conda-forge::r-rmarkdown
        conda-forge::r-knitr
        conda-forge::bc
      '''
    }

}

conda {
  enabled = true
  cacheDir = '/work/birdlab/.conda_builds'
  autoActivate = true
  channels = ['bioconda', 'conda-forge', 'defaults']
  createTimeout = '1 h'
}

// Execution profiles
profiles {
  slurm {
    process.executor = 'slurm'
  }
  
  local {
    process.executor = 'local'
    process.cpus = 4
    //process.memory = '8 GB'
  }
  
  docker {
    docker.enabled = true
    process.container = 'quay.io/biocontainers/nextflow:latest'
  }
}

// Enable timeline and resource reports
timeline {
  enabled = true
  overwrite = true
  file = "${params.output_dir}/pipeline/pipeline_timeline.html"
}

report {
  enabled = true
  overwrite = true
  file = "${params.output_dir}/pipeline/pipeline_report.html"
}

trace {
  enabled = true
  overwrite = true
  file = "${params.output_dir}/pipeline/pipeline_trace.txt"
}

// Enhanced DAG configuration in nextflow.config
dag {
  enabled = true
  overwrite = true
  file = "${params.output_dir}/pipeline/pipeline_dag.png"
  
  // Additional styling options
  graph {
    // Graph-level attributes
    rankdir = 'TB'          // Top to bottom layout (TB, BT, LR, RL)
    bgcolor = 'white'       // Background color
    fontname = 'Arial'      // Font for the graph
    fontsize = 14           // Font size
    dpi = 300              // Resolution for PNG output
  }
  
  node {
    // Node-level attributes
    shape = 'box'           // Node shape (box, ellipse, circle, etc.)
    style = 'rounded,filled' // Node style
    fillcolor = 'lightblue' // Default fill color
    fontname = 'Arial'      // Font for nodes
    fontsize = 12           // Font size for nodes
  }
  
  edge {
    // Edge-level attributes
    color = 'gray'          // Edge color
    fontname = 'Arial'      // Font for edge labels
    fontsize = 10           // Font size for edge labels
  }
}